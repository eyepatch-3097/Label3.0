{% extends "base.html" %} {% block title %}Design Super Template – {{
template.name }}{% endblock %} {% block content %}
<div class="row justify-content-center">
  <div class="col-lg-10">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h1 class="h4 mb-1">Design Super Template: {{ template.name }}</h1>
        <div class="text-muted small">
          Size: {{ template.width_cm }} × {{ template.height_cm }} cm @ {{
          template.dpi }} DPI
        </div>
      </div>
      <a href="{% url 'global_template_list' %}" class="btn btn-link btn-sm"
        >← Back to Super Templates</a
      >
    </div>

    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-3 mb-3">
        <div class="card shadow-sm">
          <div class="card-body p-3">
            <h6 class="mb-2">Special Fields</h6>
            <div class="mb-2">
              <div class="d-flex justify-content-between align-items-center">
                <span>Barcode</span>
                <button
                  type="button"
                  class="btn btn-sm btn-outline-primary btn-add-field"
                  data-name="Barcode"
                  data-key="barcode"
                  data-field-type="BARCODE"
                >
                  Add
                </button>
              </div>
            </div>
            <div class="mb-3">
              <div class="d-flex justify-content-between align-items-center">
                <span>QR Code</span>
                <button
                  type="button"
                  class="btn btn-sm btn-outline-primary btn-add-field"
                  data-name="QR Code"
                  data-key="qrcode"
                  data-field-type="QRCODE"
                >
                  Add
                </button>
              </div>
            </div>

            <hr class="my-2" />

            <h6 class="mb-2">New Custom Field</h6>
            <div class="mb-2">
              <label class="form-label small mb-1">Field Name</label>
              <input
                type="text"
                id="newFieldName"
                class="form-control form-control-sm"
              />
            </div>
            <div class="mb-3">
              <label class="form-label small mb-1">Field Type</label>
              <select id="newFieldType" class="form-select form-select-sm">
                {% for val, label in field_type_choices %}
                <option value="{{ val }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <button
              type="button"
              id="btnAddCustomField"
              class="btn btn-sm btn-success"
            >
              Add Custom Field
            </button>
          </div>
        </div>
      </div>

      <!-- Canvas -->
      <div class="col-md-9 mb-3">
        <div class="card shadow-sm">
          <div class="card-body p-3">
            <form id="canvasForm" method="post">
              {% csrf_token %}
              <input type="hidden" name="layout_data" id="layoutData" />
              <div
                id="canvas"
                class="border bg-light position-relative mb-3"
                style="width: {{ canvas_width }}px; height: {{ canvas_height }}px; overflow: hidden;"
              ></div>

              <div class="row">
                <div class="col-md-4 mb-2">
                  <label class="form-label small mb-1"
                    >Selected Width (px)</label
                  >
                  <input
                    type="number"
                    id="selectedWidth"
                    class="form-control form-control-sm"
                  />
                </div>
                <div class="col-md-4 mb-2">
                  <label class="form-label small mb-1"
                    >Selected Height (px)</label
                  >
                  <input
                    type="number"
                    id="selectedHeight"
                    class="form-control form-control-sm"
                  />
                </div>
                <div class="col-md-4 mb-2 small d-flex align-items-end">
                  <span id="selectedInfo" class="text-muted"
                    >No field selected.</span
                  >
                </div>
              </div>

              <div class="d-flex justify-content-between mt-3">
                <a
                  href="{% url 'global_template_list' %}"
                  class="btn btn-outline-secondary"
                >
                  Cancel
                </a>
                <button type="submit" class="btn btn-primary">
                  Save &amp; Preview
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    const canvas = document.getElementById("canvas");
    const selectedWidthInput = document.getElementById("selectedWidth");
    const selectedHeightInput = document.getElementById("selectedHeight");
    const selectedInfo = document.getElementById("selectedInfo");
    const layoutDataInput = document.getElementById("layoutData");

    let boxes = [];
    let selectedBox = null;

    // existing_layout is already a JSON array literal from the view
    const existingLayout = {{ existing_layout|safe }};


    function renderLayoutFromData(layout) {
      canvas.innerHTML = "";
      boxes = [];
      layout.forEach(item => createFieldBox(item));
    }

    function createFieldBox(field) {
      const box = document.createElement("div");
      box.className = "position-absolute bg-white border rounded px-2 py-1 small draggable-field";
      box.style.left = field.x + "px";
      box.style.top = field.y + "px";
      box.style.width = field.width + "px";
      box.style.height = field.height + "px";
      box.style.cursor = "move";
      box.dataset.key = field.key;
      box.dataset.fieldType = field.field_type || "";
      box.dataset.name = field.name;

      box.innerHTML = `
        <span>${field.name}</span>
        <button type="button" class="btn-close btn-close-sm ms-2 float-end" aria-label="Remove"></button>
      `;

      canvas.appendChild(box);

      boxes.push({
        el: box,
        data: field,
      });

      box.addEventListener("mousedown", onMouseDownBox);
      box.querySelector("button").addEventListener("click", (e) => {
        e.stopPropagation();
        canvas.removeChild(box);
        boxes = boxes.filter(b => b.el !== box);
        if (selectedBox && selectedBox.el === box) {
          selectedBox = null;
          selectedWidthInput.value = "";
          selectedHeightInput.value = "";
          selectedInfo.textContent = "No field selected.";
        }
      });

      box.addEventListener("click", (e) => {
        e.stopPropagation();
        selectBox(box);
      });
    }

    function selectBox(box) {
      selectedBox = boxes.find(b => b.el === box);
      boxes.forEach(b => (b.el.style.outline = ""));
      if (selectedBox) {
        selectedBox.el.style.outline = "2px solid #0d6efd";
        selectedWidthInput.value = selectedBox.data.width;
        selectedHeightInput.value = selectedBox.data.height;
        selectedInfo.textContent = `Editing: ${selectedBox.data.name} (${selectedBox.data.key})`;
      }
    }

    function onMouseDownBox(e) {
      if (e.target.tagName.toLowerCase() === "button") return;
      const box = e.currentTarget;
      selectBox(box);

      const rect = canvas.getBoundingClientRect();
      const startX = e.clientX - rect.left - parseInt(box.style.left, 10);
      const startY = e.clientY - rect.top - parseInt(box.style.top, 10);

      function onMouseMove(ev) {
        const x = ev.clientX - rect.left - startX;
        const y = ev.clientY - rect.top - startY;
        box.style.left = Math.max(0, Math.min(canvas.clientWidth - box.offsetWidth, x)) + "px";
        box.style.top = Math.max(0, Math.min(canvas.clientHeight - box.offsetHeight, y)) + "px";
        const record = boxes.find(b => b.el === box);
        if (record) {
          record.data.x = parseInt(box.style.left, 10);
          record.data.y = parseInt(box.style.top, 10);
        }
      }

      function onMouseUp() {
        document.removeEventListener("mousemove", onMouseMove);
        document.removeEventListener("mouseup", onMouseUp);
      }

      document.addEventListener("mousemove", onMouseMove);
      document.addEventListener("mouseup", onMouseUp);
    }

    // Add special/custom fields
    document.querySelectorAll(".btn-add-field").forEach(btn => {
      btn.addEventListener("click", function () {
        const fieldType = this.dataset.fieldType || "";
        const key = this.dataset.key || "";

        let width = 140;
        let height = 32;
        if (key === "barcode" || fieldType === "BARCODE") {
          width = 250;
          height = 60;
        } else if (key === "qrcode" || fieldType === "QRCODE") {
          width = 100;
          height = 100;
        }

        const field = {
          name: this.dataset.name,
          key: key,
          field_type: fieldType,
          x: 10,
          y: 10,
          width: width,
          height: height,
        };
        createFieldBox(field);
      });
    });

    const customNameInput = document.getElementById("newFieldName");
    const customTypeSelect = document.getElementById("newFieldType");
    document.getElementById("btnAddCustomField").addEventListener("click", function () {
      const name = customNameInput.value.trim();
      const fieldType = customTypeSelect.value;
      if (!name) {
        alert("Please enter a field name");
        return;
      }
      const key = name.toLowerCase().replace(/\s+/g, "_");

      let width = 140;
      let height = 32;
      if (fieldType === "BARCODE") {
        width = 250;
        height = 60;
      } else if (fieldType === "QRCODE") {
        width = 100;
        height = 100;
      }

      const field = {
        name: name,
        key: key,
        field_type: fieldType,
        x: 10,
        y: 10,
        width: width,
        height: height,
      };
      createFieldBox(field);
      customNameInput.value = "";
    });

    selectedWidthInput.addEventListener("change", function () {
      if (!selectedBox) return;
      const w = parseInt(this.value, 10) || selectedBox.data.width;
      selectedBox.data.width = w;
      selectedBox.el.style.width = w + "px";
    });
    selectedHeightInput.addEventListener("change", function () {
      if (!selectedBox) return;
      const h = parseInt(this.value, 10) || selectedBox.data.height;
      selectedBox.data.height = h;
      selectedBox.el.style.height = h + "px";
    });

    document.getElementById("canvasForm").addEventListener("submit", function () {
      const payload = boxes.map(b => b.data);
      layoutDataInput.value = JSON.stringify(payload);
    });

    renderLayoutFromData(existingLayout);
  })();
</script>
{% endblock %}
